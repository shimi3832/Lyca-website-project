<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Sari-Sari Store - Tindahan ni Mare</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        /* base */
        body{font-family:Arial, Helvetica, sans-serif;background:#f5f9f0;color:#333;transition:0.3s;background-size:cover;background-position:center}
        body.dark{background:#1a1a1a;color:#f0f0f0}

        /* emoji helper - prefer platform color emoji fonts */
        .emoji{font-family:"Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji","Segoe UI Symbol","EmojiSymbols";line-height:1;display:inline-block}
        body.dark .emoji{ /* keep emoji visible in dark mode */ color:inherit; }

        /* Dark-mode text fixes */
        body.dark input, body.dark select, body.dark textarea, body.dark p, body.dark label, body.dark span, body.dark strong {
            color: #f0f0f0;
        }
        body.dark input, body.dark select, body.dark textarea { background:#2b2b2b; border-color:#555; }
        body.dark ::placeholder { color: #bfbfbf; }

        .logo-img{height:45px;width:45px;border-radius:50%;object-fit:cover;border:2px solid #9acd32;background:white}
        .prod-thumb{width:50px;height:50px;object-fit:cover;border-radius:5px;border:1px solid #ddd}
        body.dark .card{background:#2a2a2a}
        body.dark nav{background:#2a2a2a}
        body.dark main{background:#1a1a1a}
        body.dark .box{background:#2a2a2a;color:#f0f0f0}
        body.dark h1,body.dark h3{color:#9acd32}
        body.dark table{background:#2a2a2a}
        body.dark td{color:#f0f0f0}
        body.dark p{color:#f0f0f0}
        body.dark .error{color:#ffb3b3;background:#4a1a1a}
        body.dark .link{color:#9acd32}
        body.dark table th{background:#1a1a1a;color:#f0f0f0}
        body.dark .stat{background:#333;color:#f0f0f0}
        body.dark .stat-num{color:#9acd32}
        body.dark .card#announce{background:#1a2a4a!important;color:#f0f0f0}
        body.dark #notlist>div{background:#1a3a6a!important;color:#f0f0f0}
        body.dark #actacc{color:#f0f0f0}
        body.dark #actacc .acc-item{background:#333;color:#f0f0f0}
        body.dark #actacc .acc-item strong{color:#f0f0f0}
        body.dark #pend .acc-item{background:#333;color:#f0f0f0}
        body.dark #pend .acc-item strong{color:#f0f0f0}
        body.dark #accs .acc-item{background:#333;color:#f0f0f0}
        body.dark #accs .acc-item strong{color:#f0f0f0}
        body.dark #accs .acc-item span{color:#f0f0f0}

        /* recovery inner box styles and dark-mode override so text is visible */
        .recovery-inner{background:white;padding:15px;border-radius:6px;margin-top:10px;color:inherit}
        body.dark .recovery-inner{ background:#2b2b2b; color:#f0f0f0; border:1px solid #3a3a3a; }

        .screen{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,#2d5016,#6b8e23);display:flex;align-items:center;justify-content:center}
        .hidden{display:none!important}
        .box{background:white;padding:40px;border-radius:10px;width:90%;max-width:400px;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,0.3)}
        .box h2{color:#2d5016;margin-bottom:20px;font-size:2rem}
        .box input,.box select{width:100%;padding:12px;margin:10px 0;border:2px solid #ddd;border-radius:6px;font-size:1rem}
        .box button{width:100%;padding:12px;background:linear-gradient(135deg,#2d5016,#6b8e23);color:white;border:none;border-radius:6px;font-weight:bold;cursor:pointer;margin-top:15px}
        .box button:hover{opacity:0.9}
        .error{color:red;margin:10px 0;font-weight:bold}
        .link{margin-top:15px;color:#2d5016;cursor:pointer;font-weight:600;text-decoration:underline}
        .app{display:none}
        header{background:linear-gradient(135deg,#2d5016,#6b8e23);color:white;padding:10px 15px;display:flex;justify-content:space-between;align-items:center;gap:10px}
        .hamburger{background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;padding:10px}
        .hamburger span{display:block;width:25px;height:3px;background:white;margin:5px 0}
        .container{display:flex;min-height:calc(100vh - 60px)}
        nav{width:200px;background:white;padding:15px 0;border-right:2px solid #ddd;overflow-y:auto}
        nav.hidden{display:none}
        .nav-item{padding:15px 20px;cursor:pointer;border-left:4px solid transparent;transition:0.3s;display:flex;gap:8px;align-items:center}
        .nav-item:hover{background:#f0f0f0}
        .nav-item.active{background:#f0f0f0;border-left-color:#6b8e23;color:#2d5016;font-weight:bold}
        main{flex:1;padding:30px;overflow-y:auto}
        .section{display:none}
        .section.active{display:block}
        h1{color:#2d5016;margin-bottom:20px;border-bottom:3px solid #9acd32;padding-bottom:10px}
        h3{color:#2d5016;margin-top:15px;margin-bottom:10px}
        .card{background:white;padding:20px;border-radius:8px;margin:20px 0;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
        .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin:20px 0}
        .stat{background:#f0f0f0;padding:20px;border-radius:8px;text-align:center}
        .stat-num{font-size:2rem;color:#2d5016;font-weight:bold}
        table{width:100%;border-collapse:collapse;margin-top:15px}
        th{background:#2d5016;color:white;padding:12px;text-align:left}
        td{padding:12px;border-bottom:1px solid #e0e0e0;vertical-align:middle}
        .btn{padding:10px 15px;background:#2d5016;color:white;border:none;border-radius:5px;cursor:pointer;margin-right:10px;margin-bottom:10px}
        .btn:hover{opacity:0.8}
        .btn-danger{background:#c85a54}
        .btn-success{background:#28a745}
        input,select,textarea{width:100%;padding:10px;margin:8px 0;border:1px solid #ddd;border-radius:4px;font-family:Arial}
        .acc-item{background:#f9f9f9;padding:12px;margin:10px 0;border-radius:6px;display:flex;justify-content:space-between;align-items:center}
        .acc-item.pending{background:#fff3cd}
        .small-muted{font-size:0.9rem;color:#666}
        .brand-preview{display:flex;gap:10px;align-items:center}
        .brand-preview img{height:60px;width:60px;border-radius:8px;object-fit:cover;border:1px solid #ddd}
    </style>
</head>
<body>
<div id="login" class="screen">
    <div class="box">
        <img id="mainLogo" src="1000017768.png" style="width:100px;height:100px;border-radius:50%;margin-bottom:10px;border:3px solid #6b8e23">
        <h2>Tindahan ni Mare</h2>
        <div class="error" id="err"></div>
        <select id="role"><option value="">Select Role</option><option value="admin">Admin</option><option value="owner">Owner</option><option value="employee">Employee</option></select>
        <input type="text" id="user" placeholder="Username">
        <input type="password" id="pass" placeholder="Password">
        <button onclick="doLogin()">LOGIN</button>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
            <div class="link" onclick="toSignup()">Create Account</div>
            <div class="link" onclick="showForgotOptions()">Forgot username/password?</div>
        </div>
    </div>
</div>

<div id="signup" class="screen hidden">
    <div class="box">
        <h2>Create Account</h2>
        <div class="error" id="err2"></div>
        <select id="srole"><option value="">Select Role</option><option value="owner">Owner</option><option value="employee">Employee</option></select>
        <input type="text" id="suser" placeholder="Username">
        <input type="password" id="spass" placeholder="Password">
        <input type="password" id="spass2" placeholder="Confirm">
        <button onclick="doSignup()">CREATE</button>
        <div class="link" onclick="toLogin()">Back</div>
    </div>
</div>

<div id="forgotOptions" class="screen hidden">
    <div class="box">
        <h2>Account Recovery</h2>
        <p class="small-muted">Choose recovery method</p>
        <button class="btn btn-success" onclick="showAdminRecovery()" style="margin-top:12px"><span class="emoji">üõü</span> Admin Emergency Recovery</button>
        <button class="btn" onclick="showUserRecovery()" style="margin-top:12px;background:#ffc107"><span class="emoji">üìù</span> Submit Recovery Request (Owner/Employee)</button>
        <div class="link" onclick="toLogin()">Back to Login</div>
    </div>
</div>

<div id="adminRecovery" class="screen hidden">
    <div class="box">
        <h2>Admin Emergency Recovery</h2>
        <p class="small-muted">Enter emergency code (admin-only)</p>
        <input type="text" id="emergencyCode" placeholder="Emergency Code">
        <div style="display:flex;gap:10px">
            <button class="btn btn-success" onclick="adminRecovery()">Use Code</button>
            <button class="btn" onclick="toLogin()" style="background:#666">Cancel</button>
        </div>
        <p style="margin-top:12px;font-size:0.9rem;color:#666">If code is valid you'll be prompted to set a new admin username/password.</p>
    </div>
</div>

<div id="userRecovery" class="screen hidden">
    <div class="box">
        <h2>Submit Recovery Request</h2>
        <div class="error" id="recErr"></div>
        <select id="recRole"><option value="">Select Role</option><option value="owner">Owner</option><option value="employee">Employee</option></select>
        <input type="text" id="recUser" placeholder="Your Username (if known)">
        <textarea id="recReason" placeholder="Describe issue (e.g. forgot password)" style="height:80px"></textarea>
        <div style="display:flex;gap:10px">
            <button class="btn btn-success" onclick="submitRecoveryRequest()">Submit</button>
            <button class="btn" onclick="toLogin()" style="background:#666">Cancel</button>
        </div>
    </div>
</div>

<div id="app" class="app">
    <header id="appHeader">
        <div style="display:flex;align-items:center;gap:10px">
            <button class="hamburger" onclick="toggleMenu()"><span></span><span></span><span></span></button>
            <img id="headerLogo" src="logo.png" class="logo-img">
        </div>
        <div id="uinfo" style="color:white;flex:1;text-align:right;padding-right:15px"></div>
        <button class="btn" onclick="toggleDark()" style="margin:0 5px;background:rgba(255,255,255,0.2)"><span class="emoji">üåô</span></button>
        <button class="btn" onclick="doLogout()" style="margin:0">LOGOUT</button>
    </header>

    <div class="container">
        <nav id="nav">
            <div class="nav-item active" onclick="goTo('dash')"><span class="emoji">üìä</span><span>Dashboard</span></div>
            <div class="nav-item" onclick="goTo('inv')"><span class="emoji">üì¶</span><span>Inventory</span></div>
            <div class="nav-item" onclick="goTo('prod')"><span class="emoji">üõçÔ∏è</span><span>Products</span></div>
            <div class="nav-item" id="admenu" style="display:none" onclick="goTo('admin')"><span class="emoji">üëë</span><span>Admin</span></div>
            <div class="nav-item" onclick="goTo('notif')"><span class="emoji">üîî</span><span>Notifications</span></div>
            <div class="nav-item" onclick="goTo('settings')"><span class="emoji">‚öôÔ∏è</span><span>Settings</span></div>
        </nav>

        <main>
            <div id="dash" class="section active">
                <h1><span class="emoji">üìä</span> Dashboard</h1>
                <div class="card" id="announce" style="background:#e3f2fd;border-left:5px solid #2196f3"></div>
                <div class="stats">
                    <div class="stat"><div class="stat-num" id="items">0</div>Items</div>
                    <div class="stat"><div class="stat-num" id="stock">0</div>Stock</div>
                    <div class="stat"><div class="stat-num" id="out">0</div>Out</div>
                    <div class="stat"><div class="stat-num" id="exp">0</div>Expired</div>
                </div>
            </div>

            <div id="inv" class="section">
                <h1><span class="emoji">üì¶</span> Inventory</h1>
                <div style="margin-bottom:15px">
                    <button class="btn" onclick="addItem()"><span class="emoji">‚ûï</span> Add Product</button>
                    <button class="btn" onclick="exportCSV()">Export CSV</button>
                </div>
                <input type="text" id="search" placeholder="Search product..." onkeyup="filter()" style="width:100%;margin-bottom:15px">
                <div class="card" style="overflow-x:auto">
                    <table><thead><tr><th>#</th><th>Image</th><th>Item</th><th>Cat</th><th>Qty</th><th>Exp</th><th>Status</th><th>Stock</th><th>Act</th></tr></thead><tbody id="invtab"></tbody></table>
                </div>
            </div>

            <div id="prod" class="section">
                <h1><span class="emoji">üõçÔ∏è</span> Products</h1>
                <div class="card" style="overflow-x:auto">
                    <table><thead><tr><th>#</th><th>Image</th><th>Product</th><th>Cat</th><th>Qty</th></tr></thead><tbody id="prodtab"></tbody></table>
                </div>
            </div>

            <div id="admin" class="section">
                <h1><span class="emoji">üëë</span> Admin</h1>
                <h3><span class="emoji">üì¢</span> Announcement</h3>
                <div class="card"><textarea id="ann" placeholder="Type..." style="height:80px"></textarea><button class="btn btn-success" onclick="postAnn()">Post</button></div>

                <h3>Pending Accounts</h3>
                <div class="card" id="pend"></div>

                <h3>Recovery Requests</h3>
                <div class="card" id="recreq"></div>

                <h3>All Accounts</h3>
                <div class="card" id="accs"></div>
            </div>

            <div id="notif" class="section">
                <h1><span class="emoji">üîî</span> Notifications</h1>
                <button class="btn btn-danger" onclick="clearNotif()">Clear All</button>
                <div class="card" id="notlist"></div>
            </div>

            <div id="settings" class="section">
                <h1><span class="emoji">‚öôÔ∏è</span> Settings</h1>

                <h3>Change Username</h3>
                <div class="card">
                    <input type="text" id="newUsername" placeholder="New Username">
                    <button class="btn btn-success" onclick="changeUsername()">Update Username</button>
                </div>

                <h3>Change Password</h3>
                <div class="card">
                    <input type="password" id="curr" placeholder="Current Password">
                    <input type="password" id="new" placeholder="New Password">
                    <input type="password" id="new2" placeholder="Confirm Password">
                    <button class="btn btn-success" onclick="changePass()">Update</button>
                </div>

                <h3>Branding (Logo & Background)</h3>
                <div class="card" id="brandingCard">
                    <div class="brand-preview" style="margin-bottom:10px">
                        <img id="brandLogoPreview" src="logo.png" alt="logo preview">
                        <div>
                            <p style="margin:0"><strong>Current Logo</strong></p>
                            <p class="small-muted" style="margin:0">Only admin can change this</p>
                        </div>
                    </div>
                    <input type="file" id="brandLogo" accept="image/*">
                    <p style="margin:8px 0" class="small-muted">Background (login page background) ‚Äî <strong>admin only</strong></p>
                    <div style="margin-bottom:8px">
                        <img id="bgPreview" src="" style="max-width:100%;max-height:120px;display:none;border-radius:6px;border:1px solid #ddd">
                    </div>
                    <input type="file" id="brandBg" accept="image/*">
                    <div style="display:flex;gap:10px;margin-top:10px">
                        <button class="btn btn-success" onclick="saveBranding()">Save Branding</button>
                        <button class="btn" onclick="clearBranding()" style="background:#666">Remove</button>
                    </div>
                </div>

                <h3>Recovery Information</h3>
                <div class="card" style="background:#fff3cd;border-left:4px solid #ffc107">
                    <p style="margin-bottom:10px;color:#856404"><strong><span class="emoji">‚ö†Ô∏è</span> Save this information:</strong></p>
                    <div class="recovery-inner">
                        <p><strong>Your Username:</strong> <span id="currentUser" style="color:#2d5016;font-size:1.1rem"></span></p>
                        <p style="margin-top:8px"><strong>Your Role:</strong> <span id="currentRole" style="color:#2d5016;font-size:1.1rem"></span></p>
                    </div>
                    <p style="margin-top:10px;font-size:0.9rem;color:#856404"><span class="emoji">üí°</span> Take a screenshot or write this down in case you forget!</p>
                </div>

                <h3 id="owntit" style="display:none">Pending Employees</h3>
                <div class="card" id="ownpend" style="display:none"></div>
                <h3>Active Team</h3>
                <div class="card" id="actacc"></div>
            </div>
        </main>
    </div>
</div>

<script>
/* ===== Data / initial state ===== */
let users={admin:[{u:'admin',p:'admin123',ok:1}],owner:[{u:'owner',p:'owner123',ok:1}],employee:[{u:'employee',p:'emp123',ok:1}]};
let inv=[{n:'Nissin Cup Noodles',c:'snacks',q:50,e:'2025-06-15',img:'1000017768.png'},{n:'Yellow Notebook',c:'supplies',q:60,e:'2026-12-31',img:''}];
let pending=[], ann='', user=null, role=null, recoveryRequests=[];
let nots = {}; // notifications per-user map

/* ===== persist/load ===== */
function load(){
    let d = localStorage.getItem('s18');
    if(d){
        let x = JSON.parse(d);
        users = x.u || users;
        inv = x.i || inv;
        pending = x.p || pending;
        nots = x.n || nots;
        ann = x.a || ann;
        recoveryRequests = x.r || recoveryRequests;
    }
    if(localStorage.getItem('branding')){
        applyBranding(JSON.parse(localStorage.getItem('branding')));
    } else {
        resetLoginBackgroundToDefault();
    }
}
function save(){
    localStorage.setItem('s18',JSON.stringify({u:users,i:inv,p:pending,n:nots,a:ann,r:recoveryRequests}));
}
load();

/* theme */
if(localStorage.getItem('dark')=='1') document.body.classList.add('dark');
function toggleDark(){document.body.classList.toggle('dark');localStorage.setItem('dark',document.body.classList.contains('dark')?'1':'0')}

/* notifications */
function addNotification(msg){
    if(!user) return;
    if(!nots[user]) nots[user] = [];
    nots[user].push(msg);
    save();
}

/* Login/Signup flows */
function toSignup(){document.getElementById('login').classList.add('hidden');document.getElementById('signup').classList.remove('hidden');hideAllRecoveryScreens()}
function toLogin(){hideAllTopScreens();document.getElementById('login').classList.remove('hidden');document.getElementById('signup').classList.add('hidden')}
function showForgotOptions(){hideAllTopScreens();document.getElementById('forgotOptions').classList.remove('hidden')}
function showAdminRecovery(){hideAllTopScreens();document.getElementById('adminRecovery').classList.remove('hidden')}
function showUserRecovery(){hideAllTopScreens();document.getElementById('userRecovery').classList.remove('hidden')}
function hideAllTopScreens(){document.getElementById('login').classList.add('hidden');document.getElementById('signup').classList.add('hidden');document.getElementById('forgotOptions').classList.add('hidden');document.getElementById('adminRecovery').classList.add('hidden');document.getElementById('userRecovery').classList.add('hidden')}
function hideAllRecoveryScreens(){document.getElementById('forgotOptions').classList.add('hidden');document.getElementById('adminRecovery').classList.add('hidden');document.getElementById('userRecovery').classList.add('hidden')}

function doSignup(){
    let r=document.getElementById('srole').value,u=document.getElementById('suser').value.trim(),p=document.getElementById('spass').value,p2=document.getElementById('spass2').value,e=document.getElementById('err2');
    if(!r||!u||!p||!p2){e.innerText='Fill all fields';return}
    if(p!==p2){e.innerText='Passwords do not match';return}
    if(pending.some(x=>x.u===u)){e.innerText='Already requested';return}
    pending.push({u,p,r});save();alert('‚úÖ Request Sent! Wait for Admin/Owner approval.');toLogin();
}

function doLogin(){
    let r=document.getElementById('role').value,u=document.getElementById('user').value.trim(),p=document.getElementById('pass').value,e=document.getElementById('err');
    if(!r||!u||!p){e.innerText='Fill all';return}
    if(!users[r]){e.innerText='Wrong Credentials';return}
    let a=users[r].find(x=>x.u===u&&x.p===p);
    if(!a){e.innerText='Wrong Credentials';return}
    if(!a.ok){e.innerText='Account pending/deactivated';return}
    user=u; role=r;
    document.getElementById('login').classList.add('hidden'); document.getElementById('app').style.display='block'; hideAllTopScreens();
    document.getElementById('uinfo').innerText = u+' ('+r.toUpperCase()+')';
    document.getElementById('currentUser').innerText = user;
    document.getElementById('currentRole').innerText = role;

    document.getElementById('admenu').style.display = (role==='admin') ? 'block' : 'none';
    document.getElementById('brandingCard').style.display = (role==='admin') ? 'block' : 'none';
    document.getElementById('actacc').style.display = (role==='admin' || role==='owner') ? 'block' : 'none';

    showAnn(); render(); loadAdmin(); loadNot(); loadAccountsView();
}

/* Inventory rendering/search */
function render(){
    let t=document.getElementById('invtab'),p=document.getElementById('prodtab');t.innerHTML='';p.innerHTML='';
    let tot=0,qty=0,out=0,exp=0;
    inv.forEach((it,i)=>{
        tot++;qty+=it.q;if(it.q===0)out++;
        let isExp=new Date(it.e)<new Date();if(isExp)exp++;
        let imgHtml=it.img?`<img src="${it.img}" class="prod-thumb">`:`<div class="prod-thumb" style="background:#eee;display:flex;align-items:center;justify-content:center;font-size:10px;color:#999">No Image</div>`;
        let act=(role==='owner'||role==='admin')?`<button class="btn btn-danger" onclick="del(${i})">Del</button><button class="btn" onclick="edit(${i})">Edit</button>`:`<button class="btn" onclick="edit(${i})">Edit</button>`;
        t.innerHTML+=`<tr><td>${i+1}</td><td>${imgHtml}</td><td><strong>${it.n}</strong></td><td><span style="background:#ffd4a3;padding:4px 8px;border-radius:12px;font-size:12px">${it.c}</span></td><td>${it.q}</td><td>${it.e}</td><td><span style="background:${isExp?'#dc3545':'#28a745'};color:white;padding:4px 8px;border-radius:4px;font-size:0.85rem">${isExp?'EXP':'OK'}</span></td><td><span style="background:${it.q===0?'#dc3545':'#28a745'};color:white;padding:4px 8px;border-radius:12px;font-size:12px">${it.q===0?'OUT':'IN'}</span></td><td>${act}</td></tr>`;
        p.innerHTML+=`<tr><td>${i+1}</td><td>${imgHtml}</td><td>${it.n}</td><td>${it.c}</td><td>${it.q}</td></tr>`;
    });
    document.getElementById('items').innerText=tot;document.getElementById('stock').innerText=qty;document.getElementById('out').innerText=out;document.getElementById('exp').innerText=exp; save();
}
function filter(){let f=document.getElementById('search').value.trim().toUpperCase();let rows=document.querySelectorAll('#invtab tr');rows.forEach(r=>{let text=(r.textContent||r.innerText||'').toUpperCase();r.style.display = text.includes(f) ? '' : 'none';});}

/* Add/Edit product */
function addItem(){if(role==='employee'){alert('Restricted to Owner/Admin');return}showAddModal()}
function showAddModal(){
    let m=document.createElement('div');m.style.cssText='position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:1000';
    m.innerHTML=`<div class="box" style="max-width:500px"><h2 style="color:#2d5016;margin-bottom:20px"><span class="emoji">‚ûï</span> Add New Product</h2><input type="text" id="newName" placeholder="Product Name" style="width:100%;padding:10px;margin:8px 0"><select id="newCat" style="width:100%;padding:10px;margin:8px 0"><option value="snacks">Snacks</option><option value="supplies">Supplies</option></select><input type="number" id="newQty" placeholder="Quantity" value="0" style="width:100%;padding:10px;margin:8px 0"><input type="date" id="newExp" value="2025-12-31" style="width:100%;padding:10px;margin:8px 0"><div style="margin:15px 0"><label style="display:block;margin-bottom:5px;font-weight:bold;color:#2d5016">Upload Image:</label><input type="file" id="newImg" accept="image/*" style="width:100%;padding:8px;border:2px dashed #9acd32;border-radius:5px"><img id="imgPreview" style="max-width:100%;max-height:150px;margin-top:10px;display:none;border-radius:5px"></div><button class="btn btn-success" onclick="saveNewItem()" style="width:48%;margin-right:2%">Save</button><button class="btn" onclick="closeModal()" style="width:48%;background:#666">Cancel</button></div>`;
    document.body.appendChild(m);m.id='addModal';
    document.getElementById('newImg').onchange=function(e){let f=e.target.files[0];if(f){let r=new FileReader();r.onload=function(ev){document.getElementById('imgPreview').src=ev.target.result;document.getElementById('imgPreview').style.display='block'};r.readAsDataURL(f)}};
}
function saveNewItem(){
    let n=document.getElementById('newName').value.trim(),c=document.getElementById('newCat').value,q=parseInt(document.getElementById('newQty').value),e=document.getElementById('newExp').value,imgFile=document.getElementById('newImg').files[0];
    if(!n){alert('Product name required!');return}
    if(imgFile){let r=new FileReader();r.onload=function(ev){inv.push({n,c,q,e,img:ev.target.result}); addNotification('Added new product: '+n); render(); closeModal();}; r.readAsDataURL(imgFile)}
    else{inv.push({n,c,q,e,img:''}); addNotification('Added new product: '+n); render(); closeModal()}
}
function closeModal(){let m=document.getElementById('addModal');if(m)m.remove()}
function edit(i){showEditModal(i,inv[i])}
function showEditModal(idx,it){
    let m=document.createElement('div');m.style.cssText='position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:1000';
    m.innerHTML=`<div class="box" style="max-width:500px"><h2 style="color:#2d5016;margin-bottom:20px">Edit Product</h2><input type="text" id="editName" value="${it.n}" placeholder="Product Name" style="width:100%;padding:10px;margin:8px 0"><select id="editCat" style="width:100%;padding:10px;margin:8px 0"><option value="snacks" ${it.c==='snacks'?'selected':''}>Snacks</option><option value="supplies" ${it.c==='supplies'?'selected':''}>Supplies</option></select><input type="number" id="editQty" value="${it.q}" placeholder="Quantity" style="width:100%;padding:10px;margin:8px 0"><input type="date" id="editExp" value="${it.e}" style="width:100%;padding:10px;margin:8px 0"><div style="margin:15px 0"><label style="display:block;margin-bottom:5px;font-weight:bold;color:#2d5016">Product Image:</label><div id="currentImg" style="margin-bottom:10px">${it.img?`<div style="position:relative;display:inline-block"><img src="${it.img}" style="max-width:100%;max-height:100px;border-radius:5px"><button onclick="removeEditImg()" class="btn btn-danger" style="position:absolute;top:-8px;right:-8px;padding:4px 8px;font-size:12px;border-radius:50%;margin:0">‚úï</button></div>`:'<p style="color:#999;font-size:12px">No image</p>'}</div><input type="file" id="editImg" accept="image/*" style="width:100%;padding:8px;border:2px dashed #9acd32;border-radius:5px"><img id="editPreview" style="max-width:100%;max-height:150px;margin-top:10px;display:none;border-radius:5px"></div><button class="btn btn-success" onclick="saveEdit(${idx})" style="width:48%;margin-right:2%">Save</button><button class="btn" onclick="closeEditModal()" style="width:48%;background:#666">Cancel</button></div>`;
    document.body.appendChild(m);m.id='editModal';
    document.getElementById('editImg').onchange=function(e){let f=e.target.files[0];if(f){let r=new FileReader();r.onload=function(ev){document.getElementById('editPreview').src=ev.target.result;document.getElementById('editPreview').style.display='block';document.getElementById('currentImg').innerHTML='<p style="color:#999;font-size:12px">New image selected</p>'};r.readAsDataURL(f)}};
}
function removeEditImg(){document.getElementById('currentImg').innerHTML='<p style="color:#999;font-size:12px">Image removed</p>';document.getElementById('currentImg').dataset.removed='true'}
function saveEdit(idx){
    let n=document.getElementById('editName').value.trim(),c=document.getElementById('editCat').value,q=parseInt(document.getElementById('editQty').value),e=document.getElementById('editExp').value,imgFile=document.getElementById('editImg').files[0];
    if(!n){alert('Product name required!');return}
    let removed=document.getElementById('currentImg').dataset.removed==='true';
    if(imgFile){let r=new FileReader();r.onload=function(ev){inv[idx]={n,c,q,e,img:ev.target.result}; addNotification('Updated product: '+n); render(); closeEditModal()};r.readAsDataURL(imgFile)}
    else if(removed){inv[idx]={...inv[idx],n,c,q,e,img:''}; addNotification('Updated product: '+n); render(); closeEditModal()}
    else{inv[idx]={...inv[idx],n,c,q,e}; addNotification('Updated product: '+n); render(); closeEditModal()}
}
function closeEditModal(){let m=document.getElementById('editModal');if(m)m.remove()}

/* basic */
function doLogout(){if(confirm('Logout?')) location.reload();}
function toggleMenu(){document.getElementById('nav').classList.toggle('hidden')}
function goTo(id){
    document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
    let sec=document.getElementById(id); if(sec) sec.classList.add('active');
    document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
    let navs=Array.from(document.querySelectorAll('.nav-item'));
    let match=navs.find(n=>{let oc=n.getAttribute('onclick')||'';return oc.includes("'" + id + "'") || oc.includes('"' + id + '"') || oc.includes(id)});
    if(match) match.classList.add('active');
    if(id==='admin'||id==='settings') loadAdmin();
    if(id==='notif') loadNot();
}

/* delete inventory */
function del(i){ if(confirm('Delete this item?')){ inv.splice(i,1); addNotification('Deleted product: index '+i); render(); } }

/* announcements */
function postAnn(){let t=document.getElementById('ann').value;if(!t)return;ann=t;save();showAnn();alert('Posted!')}
function showAnn(){let b=document.getElementById('announce');b.innerHTML=ann?`<strong>üì¢ Admin:</strong> ${ann}`:'No announcements.'}

/* export */
function exportCSV(){let csv='Product,Category,Quantity,Expiry\n';inv.forEach(i=>csv+=`${i.n},${i.c},${i.q},${i.e}\n`);let b=new Blob([csv],{type:'text/csv'}),a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='stall18_inventory.csv';a.click()}

/* notifications per-account */
function loadNot(){
    let list = (user && nots[user]) ? nots[user] : [];
    let h='';
    list.forEach((n,i)=> h+=`<div style="background:#e3f2fd;padding:12px;margin:10px 0;border-radius:6px;border-left:4px solid #2196f3;display:flex;justify-content:space-between;align-items:center"><span>${n}</span><button class="btn btn-danger" onclick="delNotif(${i})" style="margin:0;padding:6px 12px;font-size:12px">‚úï</button></div>`);
    document.getElementById('notlist').innerHTML = h || '<p>No notifications.</p>';
}
function delNotif(i){ if(!user || !nots[user]) return; nots[user].splice(i,1); save(); loadNot(); }
function clearNotif(){ if(!user) return; if(confirm('Clear all your notifications?')){ nots[user]=[]; save(); loadNot(); } }

/* accounts / admin flows */
function loadAdmin(){
    if(role==='admin'){
        let h='';pending.forEach((p,i)=>h+=`<div class="acc-item pending"><div><strong>${p.u}</strong> (${p.r})</div><div><button class="btn btn-success" onclick="app(${i})">Approve</button></div></div>`);
        document.getElementById('pend').innerHTML=h||'<p>No pending requests.</p>';

        let rHtml='';recoveryRequests.forEach((rq,i)=>{ rHtml+=`<div class="acc-item"><div><strong>${rq.username}</strong> (${rq.role})<div class="small-muted" style="margin-top:6px">${rq.reason}</div><div class="small-muted" style="margin-top:6px">${rq.date}</div></div><div><button class="btn btn-success" onclick="resolveRecovery(${i})">Resolve</button></div></div>`; });
        document.getElementById('recreq').innerHTML=rHtml||'<p>No recovery requests.</p>';

        let all='';
        for(let k in users){
            users[k].forEach((ac, idx)=>{
                let statusText = ac.ok ? 'Active' : 'Deactivated';
                if(k==='admin'){
                    all += `<div class="acc-item"><div><strong>${ac.u}</strong> <span class="small-muted">(${k})</span><div class="small-muted" style="margin-top:6px">Status: ${statusText}</div></div><div><span class="small-muted">Protected</span></div></div>`;
                } else {
                    let actionButtons = `<button class="btn btn-danger" onclick="deleteAccount('${k}',${idx})">Delete</button>`;
                    actionButtons += `<button class="btn" onclick="toggleAccountActive('${k}',${idx})">${ac.ok? 'Deactivate':'Reactivate'}</button>`;
                    all += `<div class="acc-item"><div><strong>${ac.u}</strong> <span class="small-muted">(${k})</span><div class="small-muted" style="margin-top:6px">Status: ${statusText}</div></div><div>${actionButtons}</div></div>`;
                }
            });
        }
        document.getElementById('accs').innerHTML=all||'<p>No accounts.</p>';
    } else {
        document.getElementById('pend').innerHTML='<p>Admin only</p>';
        document.getElementById('recreq').innerHTML='<p>Admin only</p>';
        document.getElementById('accs').innerHTML='';
    }
}

/* approve pending */
function app(i){let p=pending[i];if(!users[p.r])users[p.r]=[];users[p.r].push({u:p.u,p:p.p,ok:1});pending.splice(i,1);save();loadAdmin();alert('Approved '+p.u)}

/* resolve recovery */
function resolveRecovery(i){
    if(role!=='admin'){alert('Only admin can resolve recovery requests');return}
    let rq=recoveryRequests[i];
    if(!rq){alert('Not found');return}
    let newPass=prompt(`Set a new password for user "${rq.username}" (${rq.role}) ‚Äî leave blank to cancel:`);
    if(!newPass){return}
    if(!users[rq.role])users[rq.role]=[];
    let found=users[rq.role].find(u=>u.u===rq.username);
    if(found){ found.p=newPass;found.ok=1; alert(`Password updated for existing user ${rq.username}`); }
    else { users[rq.role].push({u:rq.username||('user'+Date.now()),p:newPass,ok:1}); alert(`Created new ${rq.role} account: ${rq.username}`); }
    recoveryRequests.splice(i,1);
    save();loadAdmin();loadAccountsView();
}

/* submit recovery request */
function submitRecoveryRequest(){
    let r=document.getElementById('recRole').value;
    let u=document.getElementById('recUser').value.trim();
    let reason=document.getElementById('recReason').value.trim();
    let e=document.getElementById('recErr');
    if(!r||!reason){e.innerText='Please fill role and describe your issue';return}
    recoveryRequests.push({role:r,username:u||'Unknown',reason:reason,date:new Date().toLocaleString()});
    save();
    alert('‚úÖ Recovery request submitted! Admin will review your request.');
    document.getElementById('recRole').value='';
    document.getElementById('recUser').value='';
    document.getElementById('recReason').value='';
    toLogin();
    loadAdmin();
}

/* admin emergency recovery */
function adminRecovery(){
    let code=document.getElementById('emergencyCode').value.trim();
    if(code==='RESET2025'){
        let adminUser = users.admin && users.admin[0] ? users.admin[0] : null;
        let newUsername=prompt('Enter new admin username: (leave blank to keep current)');
        if(newUsername && newUsername.length<3){alert('Username must be at least 3 characters');document.getElementById('emergencyCode').value='';return}
        let newPassword=prompt('Enter new admin password: (leave blank to keep current)');
        if(!adminUser){
            users.admin = users.admin || [];
            users.admin[0] = {u: (newUsername||'admin'), p: (newPassword||'admin123'), ok:1};
            alert('‚úÖ Admin account created.');
        } else {
            if(newUsername) adminUser.u = newUsername;
            if(newPassword) adminUser.p = newPassword;
            adminUser.ok = 1;
            alert('‚úÖ Admin credentials updated.');
        }
        save();
        document.getElementById('emergencyCode').value='';
        toLogin();
    } else {
        alert('‚ùå Invalid emergency code! Contact system administrator.');
    }
}

/* account protections */
function deleteAccount(roleName, idx){
    if(role!=='admin'){alert('Only admin can delete accounts');return}
    if(roleName==='admin'){ alert('Admin accounts cannot be deleted'); return; }
    if(!confirm(`Delete account ${users[roleName][idx].u} (${roleName})?`)) return;
    users[roleName].splice(idx,1);
    save();loadAdmin();loadAccountsView();
}
function toggleAccountActive(roleName, idx){
    if(role!=='admin'){alert('Only admin can change account status');return}
    if(roleName==='admin'){ alert('Admin accounts cannot be deactivated/reactivated'); return; }
    let acc = users[roleName][idx]; if(!acc) return; acc.ok = acc.ok ? 0 : 1; save();loadAdmin();loadAccountsView();
}

function loadAccountsView(){
    let h='';
    for(let k in users){
        users[k].forEach((a,i)=> h+=`<div class="acc-item"><div><strong>${a.u}</strong> <span class="small-muted">(${k})</span><div class="small-muted" style="margin-top:6px">Status: ${a.ok? 'Active':'Deactivated'}</div></div></div>`);
    }
    document.getElementById('actacc').innerHTML=h||'<p>No active accounts.</p>';
}

/* change pass/username */
function changePass(){let c=document.getElementById('curr').value,n=document.getElementById('new').value,n2=document.getElementById('new2').value;if(!c||!n||!n2){alert('Fill all');return}if(n!==n2){alert('New passwords do not match');return}let u=users[role].find(x=>x.u===user);if(!u||u.p!==c){alert('Wrong current password');return}u.p=n;save();alert('Password updated!');document.getElementById('curr').value='';document.getElementById('new').value='';document.getElementById('new2').value()}
function changeUsername(){let newU=document.getElementById('newUsername').value.trim();if(!newU){alert('Enter new username');return}if(users[role].some(x=>x.u===newU&&x.u!==user)){alert('Username already taken');return}let u=users[role].find(x=>x.u===user);if(!u){alert('Error finding account');return}u.u=newU;let oldUser=user;user=newU;save();document.getElementById('uinfo').innerText=user+' ('+role.toUpperCase()+')';document.getElementById('currentUser').innerText=user;alert('Username updated from "'+oldUser+'" to "'+newU+'"!');document.getElementById('newUsername').value='';loadAccountsView()}

/* branding (admin-only for both logo & login BG) */
function saveBranding(){
    if(role!=='admin'){ alert('Only admin can change branding (logo or login background).'); return; }

    let logoFile = document.getElementById('brandLogo').files[0];
    let bgFile = document.getElementById('brandBg').files[0];
    let payload = JSON.parse(localStorage.getItem('branding')||'{}');

    if(logoFile){
        let r=new FileReader();
        r.onload=function(ev){
            payload.logo = ev.target.result;
            if(document.getElementById('headerLogo')) document.getElementById('headerLogo').src = payload.logo;
            if(document.getElementById('mainLogo')) document.getElementById('mainLogo').src = payload.logo;
            if(document.getElementById('brandLogoPreview')) document.getElementById('brandLogoPreview').src = payload.logo;
            localStorage.setItem('branding',JSON.stringify(payload));
            alert('Branding saved!');
        }; r.readAsDataURL(logoFile);
    }
    if(bgFile){
        let r2=new FileReader();
        r2.onload=function(ev){
            payload.bg = ev.target.result;
            localStorage.setItem('branding',JSON.stringify(payload));
            applyBranding(payload);
            alert('Background saved! (login page updated)');
        }; r2.readAsDataURL(bgFile);
    }
    if(!logoFile && !bgFile){ alert('Choose logo or background file first.'); return; }
}
function applyBranding(payload){
    try{
        if(payload.logo){
            if(document.getElementById('headerLogo')) document.getElementById('headerLogo').src = payload.logo;
            if(document.getElementById('mainLogo')) document.getElementById('mainLogo').src = payload.logo;
            if(document.getElementById('brandLogoPreview')) document.getElementById('brandLogoPreview').src = payload.logo;
        }
        if(payload.bg){
            let loginEl = document.getElementById('login');
            if(loginEl){
                loginEl.style.backgroundImage = `url(${payload.bg})`;
                loginEl.style.backgroundSize = 'cover';
                loginEl.style.backgroundPosition = 'center';
            }
            if(document.getElementById('bgPreview')){
                document.getElementById('bgPreview').src = payload.bg;
                document.getElementById('bgPreview').style.display='block';
            }
        } else {
            resetLoginBackgroundToDefault();
            if(document.getElementById('bgPreview')) document.getElementById('bgPreview').style.display='none';
        }
    }catch(e){ console.warn('applyBranding failed', e) }
}
function resetLoginBackgroundToDefault(){
    let loginEl = document.getElementById('login');
    if(loginEl){
        loginEl.style.backgroundImage = '';
        loginEl.style.background = 'linear-gradient(135deg,#2d5016,#6b8e23)';
    }
}
function clearBranding(){
    if(role!=='admin'){ alert('Only admin can clear branding.'); return; }
    localStorage.removeItem('branding');
    if(document.getElementById('headerLogo')) document.getElementById('headerLogo').src = 'logo.png';
    if(document.getElementById('mainLogo')) document.getElementById('mainLogo').src = '1000017768.png';
    resetLoginBackgroundToDefault();
    if(document.getElementById('brandLogoPreview')) document.getElementById('brandLogoPreview').src='logo.png';
    if(document.getElementById('bgPreview')) document.getElementById('bgPreview').style.display='none';
    alert('Branding cleared.');
}

/* initial render */
render();
</script>
</body>
</html>